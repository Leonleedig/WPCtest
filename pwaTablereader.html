<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è³‡æ–™ç›¤é» PWA</title>
    <!-- PWA Basic Meta -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* å¡ç‰‡éæ¸¡å‹•ç•« */
        .details-content {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s ease-out;
        }
        .details-open { grid-template-rows: 1fr; }

        /* PWA æŒ‰éˆ•è§¸æ„Ÿ */
        .btn-active:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden">

    <!-- ç½®é ‚ç‹€æ…‹åˆ— -->
    <header class="bg-indigo-600 text-white safe-area-top sticky top-0 z-40 shadow-lg">
        <div class="px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="database" size="20"></i>
                <h1 class="font-black tracking-tight text-lg text-white">è³‡æ–™ç›¤é» PRO</h1>
            </div>
            <div class="flex gap-3">
                <button onclick="document.getElementById('fileInput').click()" class="p-2 bg-white/10 rounded-full btn-active text-white">
                    <i data-lucide="file-up" size="20"></i>
                </button>
                <button onclick="toggleConfig()" class="p-2 bg-white/10 rounded-full btn-active text-white">
                    <i data-lucide="settings-2" size="20"></i>
                </button>
            </div>
        </div>
        
        <!-- æ‰‹æ©Ÿç‰ˆå·¥ä½œè¡¨åˆ‡æ›å™¨ -->
        <div id="sheet-bar" class="px-4 pb-2 flex gap-2 overflow-x-auto no-scrollbar hidden bg-indigo-600">
            <!-- å‹•æ…‹ç”Ÿæˆå·¥ä½œè¡¨ Tab -->
        </div>
    </header>

    <!-- é…ç½®æŠ½å±œ -->
    <div id="config-drawer" class="fixed inset-0 z-50 pointer-events-none transition-all duration-300 opacity-0">
        <div class="absolute inset-0 bg-black/50" onclick="toggleConfig()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 transition-transform translate-y-full pointer-events-auto shadow-2xl safe-area-bottom">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-800"><i data-lucide="sliders"></i> é›²ç«¯ä¾†æºè¨­å®š</h2>
            
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 pb-4">
                <div class="p-4 bg-indigo-50 rounded-2xl border border-indigo-100 mb-4">
                    <p class="text-xs text-indigo-700 leading-relaxed font-bold mb-2">
                        ğŸš€ æ”¯æ´å¤šç¨®é›²ç«¯ä¾†æºï¼š
                    </p>
                    <ul class="text-[10px] text-indigo-600 space-y-1 list-disc pl-4">
                        <li><strong>Google Sheets</strong>: è«‹ä½¿ç”¨ã€Œç™¼å¸ƒåˆ°ç¶²è·¯ã€ç¶²å€ã€‚</li>
                        <li><strong>OneDrive</strong>: è«‹ä½¿ç”¨æª”æ¡ˆçš„ã€ŒåµŒå…¥ã€é€£çµã€‚</li>
                        <li><strong>Direct Link</strong>: ä»»ä½•æŒ‡å‘ .xlsx çš„å…¬é–‹ URLã€‚</li>
                    </ul>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 uppercase">å·¥ä½œè¡¨</label>
                        <select id="sheet-selector" onchange="changeSheet()" class="w-full p-3 bg-slate-100 rounded-xl border-none text-sm font-bold"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 uppercase">å¹´ä»½/æ’åº</label>
                        <select id="field-year" onchange="updateMapping()" class="w-full p-3 bg-slate-100 rounded-xl border-none text-sm"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 uppercase">æ¨™é¡Œ</label>
                        <select id="field-title" onchange="updateMapping()" class="w-full p-3 bg-slate-100 rounded-xl border-none text-sm"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 uppercase">åˆ†é¡æ¨™ç±¤</label>
                        <select id="field-category" onchange="updateMapping()" class="w-full p-3 bg-slate-100 rounded-xl border-none text-sm"></select>
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-400 uppercase">è©³ç´°å…§æ–‡</label>
                    <select id="field-summary" onchange="updateMapping()" class="w-full p-3 bg-slate-100 rounded-xl border-none text-sm"></select>
                </div>
                <div class="pt-4">
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block text-indigo-600">é›²ç«¯ç¶²å€ (URL)</label>
                    <div class="flex gap-2">
                        <input type="text" id="urlInput" placeholder="è²¼ä¸Š Google æˆ– OneDrive é€£çµ..." class="flex-grow p-3 bg-slate-100 rounded-xl text-sm border-none shadow-inner">
                        <button onclick="loadFromUrl()" class="p-3 bg-indigo-600 text-white rounded-xl shadow-lg btn-active"><i data-lucide="download"></i></button>
                    </div>
                </div>
            </div>
            <button onclick="toggleConfig()" class="w-full mt-4 py-4 bg-slate-900 text-white rounded-2xl font-bold btn-active shadow-xl">å®Œæˆä¸¦é—œé–‰</button>
        </div>
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="px-4 pt-4 pb-32">
        <!-- æœå°‹èˆ‡å£è¢‹ -->
        <div class="sticky top-[110px] z-30 bg-slate-50/95 backdrop-blur-md py-2">
            <div class="relative flex items-center gap-2">
                <div class="relative flex-grow">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="18"></i>
                    <input type="text" id="searchInput" oninput="render()" onkeydown="handleSearchKey(event)" placeholder="æœå°‹..." 
                           class="w-full pl-11 pr-4 py-3 rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-indigo-500 bg-white">
                </div>
                <button onclick="saveKeyword()" class="p-3 bg-white shadow-sm rounded-2xl text-indigo-600 btn-active border border-indigo-50">
                    <i data-lucide="bookmark-plus"></i>
                </button>
            </div>
            
            <!-- é—œéµå­—å£è¢‹ -->
            <div id="keyword-pocket" class="flex gap-2 py-3 overflow-x-auto no-scrollbar hidden">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- åˆ†é¡éæ¿¾ -->
        <div id="dynamic-filters" class="flex gap-2 overflow-x-auto no-scrollbar py-2 mb-2">
            <!-- åˆ†é¡ Tab -->
        </div>

        <!-- åŠŸèƒ½æŒ‰éˆ• -->
        <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar items-center">
            <button onclick="toggleAll(true)" class="flex-shrink-0 px-4 py-2 bg-white rounded-full text-[11px] font-bold text-slate-600 shadow-sm border border-slate-100 flex items-center gap-2 btn-active">
                <i data-lucide="maximize" size="12"></i> å…¨éƒ¨å±•é–‹
            </button>
            <button onclick="toggleAll(false)" class="flex-shrink-0 px-4 py-2 bg-white rounded-full text-[11px] font-bold text-slate-600 shadow-sm border border-slate-100 flex items-center gap-2 btn-active">
                <i data-lucide="minimize" size="12"></i> å…¨éƒ¨æ”¶åˆ
            </button>
            <div class="flex-grow"></div>
            <div class="flex-shrink-0 text-[10px] font-black text-slate-300 uppercase bg-slate-200/50 px-3 py-1.5 rounded-full">
                Found <span id="filtered-count" class="text-slate-600">0</span> / <span id="total-count">0</span>
            </div>
        </div>

        <!-- è³‡æ–™åˆ—è¡¨ -->
        <div id="render-list" class="space-y-4">
            <div class="text-center py-20 text-slate-300">
                <i data-lucide="database-backup" size="60" class="mx-auto mb-4 opacity-30"></i>
                <p class="font-bold">å°šæœªè¼‰å…¥è³‡æ–™åº«</p>
                <p class="text-xs mt-2">è«‹å¾å³ä¸Šè§’è¼‰å…¥æª”æ¡ˆæˆ–è²¼ä¸Šç¶²å€</p>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨å°èˆªæ¬„ -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-slate-100 px-8 py-3 safe-area-bottom flex justify-between items-center z-40">
        <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="flex flex-col items-center gap-1 text-indigo-600 btn-active">
            <i data-lucide="home" size="24"></i>
            <span class="text-[10px] font-bold">é¦–é </span>
        </button>
        <button onclick="toggleConfig()" class="flex flex-col items-center gap-1 text-slate-400 btn-active">
            <i data-lucide="refresh-cw" size="24"></i>
            <span class="text-[10px] font-bold">åŒæ­¥è³‡æ–™</span>
        </button>
        <button onclick="toggleAll(false)" class="flex flex-col items-center gap-1 text-slate-400 btn-active">
            <i data-lucide="layout-grid" size="24"></i>
            <span class="text-[10px] font-bold">æ¦‚è¦½</span>
        </button>
    </nav>

    <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥ -->
    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="hidden">

    <!-- ç‹€æ…‹é€šçŸ¥ -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] transition-all transform translate-y-[-100px] pointer-events-none">
        <div class="bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 text-sm font-bold border border-slate-700">
            <i id="toast-icon" data-lucide="info" size="18"></i>
            <span id="toast-msg">è¨Šæ¯å·²é€å‡º</span>
        </div>
    </div>

    <script>
        let fullWorkbook = null; 
        let rawData = [];
        let headers = [];
        let mapping = { year: 0, title: 1, category: 2, summary: 3 };
        let selectedCategories = new Set();
        let expandedItems = new Set();
        let savedKeywords = JSON.parse(localStorage.getItem('savedKeywords_mobile') || '[]');

        function toggleConfig() {
            const drawer = document.getElementById('config-drawer');
            const inner = drawer.querySelector('.absolute.bottom-0');
            if (drawer.classList.contains('opacity-0')) {
                drawer.classList.remove('opacity-0', 'pointer-events-none');
                inner.classList.remove('translate-y-full');
            } else {
                drawer.classList.add('opacity-0', 'pointer-events-none');
                inner.classList.add('translate-y-full');
            }
        }

        function handleSearchKey(e) { if (e.key === 'Enter') saveKeyword(); }

        function saveKeyword() {
            const val = document.getElementById('searchInput').value.trim();
            if (val && !savedKeywords.includes(val)) {
                savedKeywords.push(val);
                localStorage.setItem('savedKeywords_mobile', JSON.stringify(savedKeywords));
                updatePocketUI();
                showToast("å·²å­˜å…¥é—œéµå­—å£è¢‹", "bookmark");
            }
        }

        function updatePocketUI() {
            const container = document.getElementById('keyword-pocket');
            if (!savedKeywords.length) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');
            container.innerHTML = savedKeywords.map(w => `
                <div class="flex-shrink-0 flex items-center bg-white border border-slate-100 rounded-xl overflow-hidden shadow-sm">
                    <button onclick="applyPocketSearch('${w}')" class="px-3 py-2 text-xs font-bold text-slate-600 active:bg-slate-50">${w}</button>
                    <button onclick="deleteKeyword('${w}')" class="p-2 text-slate-300 hover:text-red-400 border-l border-slate-50 active:bg-red-50"><i data-lucide="x" size="12"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function deleteKeyword(w) {
            savedKeywords = savedKeywords.filter(k => k !== w);
            localStorage.setItem('savedKeywords_mobile', JSON.stringify(savedKeywords));
            updatePocketUI();
        }

        function applyPocketSearch(w) {
            document.getElementById('searchInput').value = w;
            render();
        }

        function showToast(msg, iconName = "info") {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            document.getElementById('toast-icon').setAttribute('data-lucide', iconName);
            lucide.createIcons();
            t.classList.remove('translate-y-[-100px]');
            t.classList.add('translate-y-0');
            setTimeout(() => {
                t.classList.remove('translate-y-0');
                t.classList.add('translate-y-[-100px]');
            }, 2500);
        }

        // --- Data Handling ---

        function transformUrl(url) {
            url = url.trim();
            
            // è™•ç† Google Sheets ç¶²é é è¦½ç¶²å€
            if (url.includes('docs.google.com/spreadsheets')) {
                if (url.includes('/pubhtml')) {
                    return url.replace('/pubhtml', '/pub?output=xlsx');
                } else if (url.includes('/d/')) {
                    const id = url.split('/d/')[1].split('/')[0];
                    return `https://docs.google.com/spreadsheets/d/${id}/export?format=xlsx`;
                }
            }
            
            // è™•ç† OneDrive åµŒå…¥/å…±ç”¨ç¶²å€
            if (url.includes('onedrive.live.com')) {
                // è½‰æ› embed ç‚º download
                if (url.includes('embed')) {
                    return url.replace('embed', 'download');
                }
                // è™•ç†ä¸€èˆ¬å…±ç”¨é€£çµ (éœ€åŠ ä¸Š download=1)
                if (!url.includes('download=1')) {
                    const sep = url.includes('?') ? '&' : '?';
                    return `${url}${sep}download=1`;
                }
            }

            // è™•ç† SharePoint / Business OneDrive
            if (url.includes('my.sharepoint.com')) {
                if (!url.includes('download=1')) {
                    const sep = url.includes('?') ? '&' : '?';
                    return `${url.split('?')[0]}${sep}download=1`;
                }
            }

            return url;
        }

        async function loadFromUrl() {
            let inputUrl = document.getElementById('urlInput').value.trim();
            if (!inputUrl) return;
            const finalUrl = transformUrl(inputUrl);
            showToast("æ­£åœ¨åŒæ­¥é›²ç«¯æ•¸æ“š...", "refresh-cw");
            
            try {
                // ä½¿ç”¨ allorigins ä»£ç†
                const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(finalUrl);
                const res = await fetch(proxy);
                if (!res.ok) throw new Error("è®€å–å¤±æ•—");
                const buf = await res.arrayBuffer();
                initWorkbook(buf, "é›²ç«¯è³‡æ–™åº«");
                localStorage.setItem('last_url_mobile', inputUrl);
            } catch (e) { 
                showToast("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€æ¬Šé™æˆ–ç™¼å¸ƒè¨­å®š", "alert-triangle");
            }
        }

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const f = e.target.files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = (ev) => initWorkbook(ev.target.result, f.name);
            reader.readAsArrayBuffer(f);
        });

        function initWorkbook(data, name) {
            try {
                fullWorkbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                const sheets = fullWorkbook.SheetNames;
                
                const sel = document.getElementById('sheet-selector');
                sel.innerHTML = sheets.map(s => `<option value="${s}">${s}</option>`).join('');
                
                const bar = document.getElementById('sheet-bar');
                bar.classList.remove('hidden');
                bar.innerHTML = sheets.map(s => `
                    <button onclick="loadSheetData('${s}')" data-sheet="${s}" class="sheet-tab flex-shrink-0 px-4 py-1.5 rounded-full text-[11px] font-bold transition-all bg-white/20 text-white border border-white/10">
                        ${s}
                    </button>
                `).join('');
                
                loadSheetData(sheets[0]);
                showToast("è³‡æ–™åŒæ­¥å®Œæˆ", "check");
                if (!document.getElementById('config-drawer').classList.contains('opacity-0')) toggleConfig();
            } catch (err) {
                showToast("æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªç‚º Excel æˆ– CSV", "x-circle");
            }
        }

        function loadSheetData(name) {
            document.querySelectorAll('.sheet-tab').forEach(t => {
                const active = t.dataset.sheet === name;
                t.classList.toggle('bg-white', active);
                t.classList.toggle('text-indigo-600', active);
                t.classList.toggle('bg-white/20', !active);
                t.classList.toggle('text-white', !active);
            });

            const sheet = fullWorkbook.Sheets[name];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
            if (rows.length < 1) return;
            headers = rows[0].map(h => (h || "æ¬„ä½").toString());
            rawData = rows.slice(1).filter(r => r.some(c => c !== ""));
            
            initFieldSelectors();
            updateMapping();
        }

        function initFieldSelectors() {
            ['field-year', 'field-title', 'field-category', 'field-summary'].forEach((id, idx) => {
                const el = document.getElementById(id);
                // æ™ºæ…§çŒœæ¸¬æ¬„ä½
                let defaultIdx = idx;
                if (id === 'field-year') {
                    const yearIdx = headers.findIndex(h => h.includes('å¹´') || h.includes('Year') || h.includes('å¹´åº¦'));
                    if (yearIdx !== -1) defaultIdx = yearIdx;
                }
                if (id === 'field-category') {
                    const catIdx = headers.findIndex(h => h.includes('é¡') || h.includes('å¿—æ¥­'));
                    if (catIdx !== -1) defaultIdx = catIdx;
                }
                
                el.innerHTML = headers.map((h, i) => `<option value="${i}" ${i === Math.min(defaultIdx, headers.length-1) ? 'selected' : ''}>${h}</option>`).join('');
            });
        }

        function updateMapping() {
            mapping = {
                year: parseInt(document.getElementById('field-year').value),
                title: parseInt(document.getElementById('field-title').value),
                category: parseInt(document.getElementById('field-category').value),
                summary: parseInt(document.getElementById('field-summary').value)
            };
            const cats = [...new Set(rawData.map(r => r[mapping.category]?.toString().trim()))].filter(Boolean);
            selectedCategories = new Set(cats);
            expandedItems.clear();
            render();
        }

        function toggleAll(exp) {
            if (exp) {
                const search = document.getElementById('searchInput').value.toLowerCase();
                rawData.forEach((r, idx) => {
                    const c = r[mapping.category]?.toString().trim();
                    if (selectedCategories.has(c) && r.join(' ').toLowerCase().includes(search))
                        expandedItems.add(`row-${idx}`);
                });
            } else expandedItems.clear();
            render();
        }

        function render() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = rawData.filter(r => {
                const c = r[mapping.category]?.toString().trim();
                return selectedCategories.has(c) && r.join(' ').toLowerCase().includes(search);
            });

            document.getElementById('total-count').innerText = rawData.length;
            document.getElementById('filtered-count').innerText = filtered.length;

            const cats = [...new Set(rawData.map(r => r[mapping.category]?.toString().trim()))].filter(Boolean).sort();
            const fBox = document.getElementById('dynamic-filters');
            fBox.innerHTML = cats.map(c => {
                const active = selectedCategories.has(c);
                const count = rawData.filter(r => r[mapping.category]?.toString().trim() === c).length;
                return `
                    <button onclick="toggleCat('${c}')" class="flex-shrink-0 px-4 py-2 rounded-2xl text-[11px] font-bold transition-all border shadow-sm ${
                        active ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-400 border-slate-100'
                    }">
                        ${c} <span class="ml-1 opacity-60 font-medium">${count}</span>
                    </button>
                `;
            }).join('');

            const list = document.getElementById('render-list');
            if (!filtered.length) {
                list.innerHTML = `<div class="text-center py-20 text-slate-300 font-bold">ç›®å‰æ¢ä»¶ä¸‹ç„¡ç›¸ç¬¦è³‡æ–™</div>`;
                return;
            }

            list.innerHTML = '';
            rawData.forEach((r, idx) => {
                const c = r[mapping.category]?.toString().trim();
                if (!selectedCategories.has(c) || !r.join(' ').toLowerCase().includes(search)) return;

                const id = `row-${idx}`;
                const open = expandedItems.has(id);
                const card = document.createElement('div');
                card.className = `bg-white rounded-2xl transition-all border shadow-sm active:scale-[0.98] ${open ? 'border-indigo-200 ring-4 ring-indigo-50' : 'border-white'}`;
                card.innerHTML = `
                    <div onclick="toggleItem('${id}')" class="p-5 flex items-start gap-4 transition-colors">
                        <div class="text-xl font-black text-indigo-200 tracking-tighter italic w-14 shrink-0 mt-1">${r[mapping.year] || ''}</div>
                        <div class="flex-grow">
                            <span class="text-[9px] font-black uppercase text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-lg mb-1.5 inline-block border border-indigo-100">${c}</span>
                            <h3 class="font-bold text-slate-800 leading-snug text-base">${r[mapping.title]}</h3>
                        </div>
                        <i data-lucide="chevron-down" size="18" class="shrink-0 text-slate-300 transition-transform ${open ? 'rotate-180 text-indigo-600' : ''}"></i>
                    </div>
                    <div class="details-content ${open ? 'details-open' : ''}">
                        <div class="overflow-hidden">
                            <div class="px-5 pb-6 text-sm leading-relaxed text-slate-600 whitespace-pre-wrap border-t border-slate-50 pt-4">
                                ${r[mapping.summary] || '<span class="italic opacity-50 text-xs">ç„¡è©³ç´°å…§å®¹</span>'}
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
            lucide.createIcons();
        }

        function toggleCat(c) {
            if (selectedCategories.has(c)) selectedCategories.delete(c);
            else selectedCategories.add(c);
            render();
        }

        function toggleItem(id) {
            if (expandedItems.has(id)) expandedItems.delete(id);
            else expandedItems.add(id);
            render();
        }

        // åˆå§‹åŒ–
        const lastUrl = localStorage.getItem('last_url_mobile');
        if (lastUrl) {
            document.getElementById('urlInput').value = lastUrl;
        }

        updatePocketUI();
        lucide.createIcons();
    </script>
</body>
</html>