<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動態資料驅動的網頁介面</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* 基本樣式 */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f9;
            margin: 0;
            padding: 20px;
        }

        /* 區域樣式 */
        .zone {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .zone-header {
            padding: 15px 20px;
            background-color: #eef2f5;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .zone-header h3 {
            margin: 0;
            color: #333;
            flex-grow: 1;
        }
        
        .zone-toggle-icon {
            font-size: 16px;
            margin-left: 10px;
            transition: transform 0.3s ease;
        }
        .zone.expanded .zone-toggle-icon {
            transform: rotate(180deg);
        }

        .zone-content {
            padding: 10px;
            border-top: 1px solid #ddd;
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
        }

        .zone.expanded .zone-content {
            max-height: 500px;
            padding: 10px;
        }

        /* 物件樣式 */
        .object {
            position: relative;
            background-color: #fafafa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            cursor: grab;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.4s ease;
        }
        .object[data-panel-open="false"] {
            cursor: pointer;
        }
        .object[data-panel-open="true"] {
            cursor: default;
        }
        .object.hidden {
            display: none;
        }
        .object:active {
            cursor: grabbing;
        }
        .object.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        /* 損壞物件樣式 */
        .object.corrupted {
            background-color: #f44336; /* 紅色背景 */
            color: white; /* 白色文字 */
        }
        .object.corrupted:hover {
            background-color: #d32f2f;
        }

        /* 新增: 儲備/暫代物件樣式 */
        .object.reserved {
            background-color: #ff9900;
            color: white;
        }
        .object.reserved:hover {
            background-color: #e68a00;
        }

        /* 物件資訊面板樣式 */
        .object-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90vw;
            max-width: 600px;
            height: 90vh;
            max-height: 800px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            padding: 20px;
            z-index: 1001;
            display: none;
            flex-direction: column;
            justify-content: space-between;
        }
        .object-panel h4 {
            margin-top: 0;
        }
        .object-panel.visible {
            display: flex;
        }
        .object-panel .panel-body {
            flex-grow: 1;
            overflow-y: auto;
            cursor: copy;
            padding-bottom: 20px;
        }
        .object-panel .close-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 20px;
            width: 40px;
            height: 40px;
            background-color: #3f51b5;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .object-panel .close-btn:hover {
            background-color: #5c6bc0;
        }
        

        /* 導航面板樣式 */
        .floating-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3f51b5;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .panel-toggle-btn {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 10px 15px;
            width: 100%;
            transition: background-color 0.2s;
        }
        .floating-panel.expanded .panel-toggle-btn {
            display: none;
        }

        .panel-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 0;
            overflow: hidden;
            padding: 0;
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
            width: 100%;
        }
        .floating-panel.expanded .panel-content {
            max-height: 300px;
            padding: 10px;
        }
        
        .panel-content .collapse-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            text-align: right;
            padding: 0 10px;
        }
        
        /* 一般按鈕樣式 */
        .toggle-btn {
            background-color: #5c6bc0;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            width: 100%;
        }

        .toggle-btn:hover {
            background-color: #7986cb;
        }
        
        /* 反白按鈕樣式（選中狀態） */
        .toggle-btn.white-bg {
            background-color: #fff;
            color: #3f51b5;
        }
        .toggle-btn.white-bg:hover {
            background-color: #e0e0e0;
        }

        /* 分類按鈕容器 */
        .category-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
        }
        .category-button {
            background-color: #5c6bc0;
            color: white;
            border: 1px solid #5c6bc0;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            text-align: center;
        }
        .category-button.active {
            background-color: #fff;
            color: #3f51b5;
        }
        .category-button:hover {
            background-color: #7986cb;
        }

        /* 拖曳目的地視覺回饋 */
        .zone-header.drag-over, .zone-content.drag-over {
            background-color: #e0e0e0;
            border: 2px dashed #999;
        }
    </style>
</head>
<body>
    
    <div id="zones-container"></div>
    
    <!-- 浮動導航面板 -->
    <div class="floating-panel">
        <button class="panel-toggle-btn">檢視 ▲</button>
        <div class="panel-content">
            <button class="collapse-btn">▼</button>
            <button class="toggle-btn" id="toggle-all-btn">全部展開</button>
            
            <div class="category-buttons" id="category-buttons-container"></div>
        </div>
    </div>

    <!-- 浮動的物件資訊面板 -->
    <div id="object-info-panel" class="object-panel">
        <div>
            <h4 id="panel-title"></h4>
            <div id="panel-content" class="panel-body"></div>
        </div>
        <button class="close-btn">&times;</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_KEY = 'AIzaSyDrKPFmjLr2-QmF9vf7nFqkC75z0M2I_B8';
            const SPREADSHEET_ID = '1UGZQa5FQY-3CaTtC7-8LfJz70sDX1UbkbVDAGciEZjQ';
            
            const zonesContainer = document.getElementById('zones-container');
            const categoryButtonsContainer = document.getElementById('category-buttons-container');
            const toggleAllBtn = document.getElementById('toggle-all-btn');
            const floatingPanel = document.querySelector('.floating-panel');
            const panelToggleBtn = document.querySelector('.panel-toggle-btn');
            const collapseBtn = document.querySelector('.collapse-btn');
            const objectInfoPanel = document.getElementById('object-info-panel');
            const objectPanelTitle = document.getElementById('panel-title');
            const objectPanelContent = document.getElementById('panel-content');
            const objectPanelCloseBtn = document.querySelector('.object-panel .close-btn');

            let draggedItem = null;
            let zones = [];
            let allObjects = [];
            
            async function fetchSpreadsheetData() {
                try {
                    const zonesUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/前端定義!D2:D?key=${API_KEY}`;
                    const categoriesUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/前端定義!C2:C?key=${API_KEY}`;
                    const objectsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/總表!A2:G?key=${API_KEY}`;

                    const [zonesRes, categoriesRes, objectsRes] = await Promise.all([
                        fetch(zonesUrl),
                        fetch(categoriesUrl),
                        fetch(objectsUrl)
                    ]);

                    const zonesData = await zonesRes.json();
                    const categoriesData = await categoriesRes.json();
                    const objectsData = await objectsRes.json();

                    renderZones(zonesData.values);
                    renderCategories(categoriesData.values);
                    renderObjects(objectsData.values);
                    
                } catch (error) {
                    console.error("無法載入試算表資料:", error);
                    // 為了避免因空資料而導致的錯誤，添加了此判斷
                    if (error.message.includes('appendChild')) {
                        alert("載入資料失敗。請檢查您的API金鑰或試算表ID，並確認試算表中有資料。");
                    } else {
                        alert("載入資料失敗。請檢查您的API金鑰或試算表ID。");
                    }
                }
            }

            function renderZones(zonesValues) {
                if (!zonesValues || zonesValues.length === 0) return;
                
                zonesValues.forEach((zoneName, index) => {
                    const zoneDiv = document.createElement('div');
                    zoneDiv.className = 'zone';
                    zoneDiv.id = `zone${index + 1}`;

                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'zone-header';
                    headerDiv.innerHTML = `<h3>${zoneName[0] || '未命名區域'}</h3><span class="zone-toggle-icon">▼</span>`;
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'zone-content';

                    zoneDiv.appendChild(headerDiv);
                    zoneDiv.appendChild(contentDiv);
                    zonesContainer.appendChild(zoneDiv);
                });
                
                // 將 NodeList 轉換為 Array 以便後續使用 find 方法
                zones = Array.from(document.querySelectorAll('.zone'));
                attachZoneEventListeners();
                updateToggleButton();
            }

            function renderCategories(categoriesValues) {
                if (!categoriesValues || categoriesValues.length === 0) return;

                categoryButtonsContainer.innerHTML = '';
                categoriesValues.forEach((categoryName) => {
                    const button = document.createElement('button');
                    button.className = 'category-button active';
                    button.setAttribute('data-category', categoryName[0]);
                    button.textContent = categoryName[0];
                    categoryButtonsContainer.appendChild(button);
                });
                attachCategoryEventListeners();
            }

            function renderObjects(objectsValues) {
                if (!objectsValues || objectsValues.length === 0) return;
                
                objectsValues.forEach((rowData, index) => {
                    if (rowData.length < 7) return; // 確保資料完整
                    
                    const objectDiv = document.createElement('div');
                    objectDiv.className = 'object';
                    objectDiv.draggable = true;
                    objectDiv.setAttribute('data-category', rowData[1]); // B欄
                    objectDiv.setAttribute('data-name', rowData[6]); // G欄
                    
                    // 物件顯示內容: 圖標後方加入 F 欄的字串
                    const objectHTML = `${rowData[6]}<span>${rowData[5]}</span>`; // G欄 + F欄

                    // 儲存內容面板所需的其他資料
                    objectDiv.setAttribute('data-col-a', rowData[0]); // A欄
                    objectDiv.setAttribute('data-col-b', rowData[1]); // B欄
                    objectDiv.setAttribute('data-col-c', rowData[2]); // C欄
                    objectDiv.setAttribute('data-col-d', rowData[3]); // D欄
                    objectDiv.setAttribute('data-col-e', rowData[4]); // E欄
                    objectDiv.setAttribute('data-col-f', rowData[5]); // F欄
                    
                    // 根據 D 欄內容添加對應的樣式類別
                    if (rowData[3] && rowData[3].includes('損壞')) {
                        objectDiv.classList.add('corrupted');
                    } else if (rowData[3] === '儲備' || rowData[3] === '暫代') {
                        objectDiv.classList.add('reserved');
                    }
                    
                    objectDiv.innerHTML = objectHTML;
                    
                    allObjects.push(objectDiv);
                    
                    // 根據C欄的值，找到並將物件放入對應的區域
                    const targetZone = zones.find(zone => {
                        return zone.querySelector('h3').textContent === rowData[2];
                    });

                    if (targetZone) {
                        targetZone.querySelector('.zone-content').appendChild(objectDiv);
                    } else {
                        // 如果找不到對應的區域，將物件添加到第一個區域作為備用
                        if (zones.length > 0) {
                            zones[0].querySelector('.zone-content').appendChild(objectDiv);
                            console.error(`找不到物件 "${rowData[0]}" 對應的區域 "${rowData[2]}"。物件已放置於第一個區域。`);
                        } else {
                            console.error("無法放置物件，因為沒有定義任何區域。");
                        }
                    }
                });

                attachObjectEventListeners();
                filterObjects(); // 初始篩選
            }

            // 附上事件監聽器
            function attachZoneEventListeners() {
                zones.forEach(zone => {
                    const header = zone.querySelector('.zone-header');
                    header.addEventListener('click', () => {
                        zones.forEach(z => {
                            if (z !== zone) {
                                z.classList.remove('expanded');
                            }
                        });
                        zone.classList.toggle('expanded');
                        updateToggleButton();
                    });

                    // 拖曳放置區域
                    const dropAreas = [header, zone.querySelector('.zone-content')];
                    dropAreas.forEach(dropArea => {
                        dropArea.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            if (draggedItem) {
                                zone.classList.add('expanded');
                                dropArea.classList.add('drag-over');
                            }
                        });

                        dropArea.addEventListener('dragleave', (e) => {
                            dropArea.classList.remove('drag-over');
                        });

                        dropArea.addEventListener('drop', (e) => {
                            e.preventDefault();
                            dropArea.classList.remove('drag-over');
                            if (draggedItem) {
                                zone.querySelector('.zone-content').appendChild(draggedItem);
                            }
                        });
                    });
                });
            }

            function attachObjectEventListeners() {
                allObjects.forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        if (e.target.getAttribute('data-panel-open') === 'true') {
                            e.preventDefault();
                            return;
                        }
                        draggedItem = e.target;
                        setTimeout(() => {
                            e.target.classList.add('dragging');
                        }, 0);
                    });

                    item.addEventListener('dragend', (e) => {
                        e.target.classList.remove('dragging');
                        draggedItem = null;
                    });

                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        
                        const openPanel = document.querySelector('.object[data-panel-open="true"]');
                        if (openPanel && openPanel !== item) {
                            openPanel.setAttribute('data-panel-open', 'false');
                        }
                        
                        const isOpen = item.getAttribute('data-panel-open') === 'true';
                        item.setAttribute('data-panel-open', !isOpen);

                        if (!isOpen) {
                            const name = item.getAttribute('data-name');
                            const colA = item.getAttribute('data-col-a');
                            const colB = item.getAttribute('data-col-b');
                            const colC = item.getAttribute('data-col-c');
                            const colD = item.getAttribute('data-col-d');
                            const colE = item.getAttribute('data-col-e');
                            const colF = item.getAttribute('data-col-f');
                            
                            // 將 textContent 改為 innerHTML 以正確顯示圖標
                            objectPanelTitle.innerHTML = name;
                            
                            objectPanelContent.innerHTML = `
                                ${colF}
                                <br>${colA}
                                <br>${colB}
                                <br>${colC}
                                <br>${colD}
                                <br>${colE}
                            `;
                            objectInfoPanel.classList.add('visible');
                            
                        } else {
                            objectInfoPanel.classList.remove('visible');
                        }
                    });
                });
            }

            function attachCategoryEventListeners() {
                const categoryButtons = document.querySelectorAll('.category-button');
                categoryButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        button.classList.toggle('active');
                        filterObjects();
                    });
                });
            }

            function areAllZonesExpanded() {
                return Array.from(zones).every(zone => zone.classList.contains('expanded'));
            }

            function updateToggleButton() {
                if (areAllZonesExpanded()) {
                    toggleAllBtn.textContent = '全部收合';
                    toggleAllBtn.classList.remove('white-bg');
                } else {
                    toggleAllBtn.textContent = '全部展開';
                    toggleAllBtn.classList.add('white-bg');
                }
            }
            
            function filterObjects() {
                const selectedCategories = Array.from(document.querySelectorAll('.category-button.active'))
                    .map(btn => btn.getAttribute('data-category'));

                allObjects.forEach(object => {
                    const category = object.getAttribute('data-category');
                    if (selectedCategories.includes(category)) {
                        object.classList.remove('hidden');
                    } else {
                        object.classList.add('hidden');
                    }
                });
            }

            // 導航面板切換
            panelToggleBtn.addEventListener('click', () => {
                floatingPanel.classList.add('expanded');
            });
            collapseBtn.addEventListener('click', () => {
                floatingPanel.classList.remove('expanded');
            });

            // 全部展開/收合按鈕
            toggleAllBtn.addEventListener('click', () => {
                if (areAllZonesExpanded()) {
                    zones.forEach(zone => zone.classList.remove('expanded'));
                } else {
                    zones.forEach(zone => zone.classList.add('expanded'));
                }
                updateToggleButton();
            });
            
            // 關閉物件面板的邏輯
            function closeObjectPanel() {
                const openPanel = document.querySelector('.object[data-panel-open="true"]');
                if (openPanel) {
                    openPanel.setAttribute('data-panel-open', 'false');
                }
                objectInfoPanel.classList.remove('visible');
            }

            objectPanelCloseBtn.addEventListener('click', closeObjectPanel);
            
            document.addEventListener('click', (e) => {
                if (objectInfoPanel.classList.contains('visible') && !objectInfoPanel.contains(e.target)) {
                    closeObjectPanel();
                }
            });

            // 複製功能
            objectPanelContent.addEventListener('mousedown', (e) => {
                const textToCopy = e.target.textContent;
                document.execCommand('copy'); // 使用舊版API確保相容性
                console.log('內容已複製到剪貼簿。');
            });
            
            // 啟動應用程式
            fetchSpreadsheetData();
        });
    </script>
</body>
</html>